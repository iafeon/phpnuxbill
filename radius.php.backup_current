<?php

// DEBUG: Log request data et lire JSON si nécessaire
$raw_input = file_get_contents("php://input");
file_put_contents("/tmp/radius_request_debug.log", date("Y-m-d H:i:s") . " - GET: " . json_encode($_GET) . " POST: " . json_encode($_POST) . " REQUEST: " . json_encode($_REQUEST) . " RAW: " . $raw_input . PHP_EOL, FILE_APPEND);

// Si rlm_rest envoie en JSON, parser le JSON et ajouter à $_REQUEST
if (!empty($raw_input) && empty($_POST)) {
    $json_data = json_decode($raw_input, true);
    if (json_last_error() === JSON_ERROR_NONE && is_array($json_data)) {
        // Fusionner les données JSON dans $_REQUEST pour que _req() puisse les lire
        $_REQUEST = array_merge($_REQUEST, $json_data);
        $_POST = array_merge($_POST, $json_data);
    }
}

/**
 *  PHP Mikrotik Billing (https://github.com/hotspotbilling/phpnuxbill)
 *  by https://t.me/ibnux
 *
 * Authorize
 *    - Voucher activation
 * Authenticate
 *    - is it allow to login
 * Accounting
 *    - log
 **/

header("Content-Type: application/json");

include "init.php";

$action = $_SERVER['HTTP_X_FREERADIUS_SECTION'];
if (empty($action)) {
    $action = _get('action');
}

$code = 200;

//debug
// if (!empty($action)) {
//     file_put_contents("$action.json", json_encode([
//         'header' => $_SERVER,
//         'get' => $_GET,
//         'post' => $_POST,
//         'time' => time()
//     ]));
// }

try {
    switch ($action) {
        case 'authenticate':
            $username = _req('username') ?: _req('User-Name');
            $password = _req('password') ?: _req('User-Password');
            file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHENTICATE: START for username=$username\n", FILE_APPEND);
            $CHAPassword = _req('CHAPassword');
            $CHAPchallenge = _req('CHAPchallenge');
            $isCHAP = false;
            if (!empty($CHAPassword)) {
                $c = ORM::for_table('tbl_customers')->select('password')->select('pppoe_password')->whereRaw("BINARY username = '$username' AND status = 'Active'")->find_one();
                if ($c) {
                    if (Password::chap_verify($c['password'], $CHAPassword, $CHAPchallenge)) {
                        $password = $c['password'];
                        $isVoucher = false;
                        $isCHAP = true;
                    } else if (!empty($c['pppoe_password']) && Password::chap_verify($c['pppoe_password'], $CHAPassword, $CHAPchallenge)) {
                        $password = $c['pppoe_password'];
                        $isVoucher = false;
                        $isCHAP = true;
                    } else {
                        // check if voucher
                        if (Password::chap_verify($username, $CHAPassword, $CHAPchallenge)) {
                            $isVoucher = true;
                            $password = $username;
                        } else {
                            // no password is voucher
                            if (Password::chap_verify('', $CHAPassword, $CHAPchallenge)) {
                                $isVoucher = true;
                                $password = $username;
                            } else {
                                show_radius_result(['Reply-Message' => 'Username or Password is wrong'], 401);
                            }
                        }
                    }
                } else {
                    $c = ORM::for_table('tbl_customers')->select('password')->select('pppoe_password')->whereRaw("BINARY pppoe_username = '$username' AND status = 'Active'")->find_one();
                    if ($c) {
                        if (Password::chap_verify($c['password'], $CHAPassword, $CHAPchallenge)) {
                            $password = $c['password'];
                            $isVoucher = false;
                            $isCHAP = true;
                        } else if (!empty($c['pppoe_password']) && Password::chap_verify($c['pppoe_password'], $CHAPassword, $CHAPchallenge)) {
                            $password = $c['pppoe_password'];
                            $isVoucher = false;
                            $isCHAP = true;
                        } else {
                            // check if voucher
                            if (Password::chap_verify($username, $CHAPassword, $CHAPchallenge)) {
                                $isVoucher = true;
                                $password = $username;
                            } else {
                                // no password is voucher
                                if (Password::chap_verify('', $CHAPassword, $CHAPchallenge)) {
                                    $isVoucher = true;
                                    $password = $username;
                                } else {
                                    show_radius_result(['Reply-Message' => 'Username or Password is wrong'], 401);
                                }
                            }
                        }
                    }
                }
            } else {
                if (!empty($username) && empty($password)) {
                    // Voucher with empty password
                    $isVoucher = true;
                    $password = $username;
                } else if (empty($username) || empty($password)) {
                    show_radius_result([
                        "control:Auth-Type" => "Reject",
                        "reply:Reply-Message" => 'Login invalid......'
                    ], 401);
                }
            }
            // Pour authenticate, on vérifie si l'utilisateur existe dans tbl_user_recharges
            // (pour les vouchers activés) ou dans tbl_customers (pour les clients normaux)
            if ($username == $password) {
                // Voucher: vérifier dans tbl_user_recharges (après activation)
                $username = Text::alphanumeric($username, "-_.,");
                $d = ORM::for_table('tbl_user_recharges')->whereRaw("BINARY username = '$username' AND status = 'on'")->find_one();
                if (!$d) {
                    // Si pas dans tbl_user_recharges, vérifier si c'est un voucher non activé
                    $v = ORM::for_table('tbl_voucher')->whereRaw("BINARY code = '$username' AND routers = 'radius'")->find_one();
                    if ($v && $v['status'] == 0) {
                        // Voucher non activé, il sera activé dans authorize
                        // Pour authenticate, on accepte et laisse authorize gérer l'activation
                        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHENTICATE: Voucher not activated yet, will be activated in authorize for $username\n", FILE_APPEND);
                        show_radius_result([
                            "control:Auth-Type" => "Accept"
                        ], 200);
                        break;
                    }
                }
            } else {
                // Client normal: vérifier dans tbl_customers
                $d = ORM::for_table('tbl_customers')->whereRaw("BINARY username = '$username' AND status = 'Active'")->find_one();
                if ($d) {
                    if ($d['password'] != $password && $d['pppoe_password'] != $password) {
                        unset($d);
                    }
                }
            }
            if ($d) {
                // Pour authenticate, on doit retourner control:Auth-Type: Accept
                // pour indiquer que l'authentification est OK
                // PAP utilisera le mot de passe dans radcheck pour vérifier
                file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHENTICATE: ACCEPTED for $username (found in " . (isset($v) ? "tbl_voucher" : (isset($d['customer_id']) ? "tbl_user_recharges" : "tbl_customers")) . ")\n", FILE_APPEND);
                show_radius_result([
                    "control:Auth-Type" => "Accept"
                ], 200);
            } else {
                file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHENTICATE: REJECTED for $username (not found)\n", FILE_APPEND);
                show_radius_result([
                    "control:Auth-Type" => "Reject",
                    "reply:Reply-Message" => 'Login invalid......'
                ], 401);
            }
            break;
        case 'authorize':
            $username = _req('username') ?: _req('User-Name');
            $password = _req('password') ?: _req('User-Password');
            $isVoucher = ($username == $password);
            $CHAPassword = _req('CHAPassword');
            $CHAPchallenge = _req('CHAPchallenge');
            $isCHAP = false;
            if (!empty($CHAPassword)) {
                $c = ORM::for_table('tbl_customers')->select('password')->select('pppoe_password')->whereRaw("BINARY username = '$username' AND status = 'Active'")->find_one();
                if ($c) {
                    if (Password::chap_verify($c['password'], $CHAPassword, $CHAPchallenge)) {
                        $password = $c['password'];
                        $isVoucher = false;
                        $isCHAP = true;
                    } else if (!empty($c['pppoe_password']) && Password::chap_verify($c['pppoe_password'], $CHAPassword, $CHAPchallenge)) {
                        $password = $c['pppoe_password'];
                        $isVoucher = false;
                        $isCHAP = true;
                    } else {
                        // check if voucher
                        if (Password::chap_verify($username, $CHAPassword, $CHAPchallenge)) {
                            $isVoucher = true;
                            $password = $username;
                        } else {
                            // no password is voucher
                            if (Password::chap_verify('', $CHAPassword, $CHAPchallenge)) {
                                $isVoucher = true;
                                $password = $username;
                            } else {
                                show_radius_result(['Reply-Message' => 'Username or Password is wrong'], 401);
                            }
                        }
                    }
                } else {
                    $c = ORM::for_table('tbl_customers')->select('password')->select('username')->select('pppoe_password')->whereRaw("BINARY pppoe_username = '$username' AND status = 'Active'")->find_one();
                    if ($c) {
                        if (Password::chap_verify($c['password'], $CHAPassword, $CHAPchallenge)) {
                            $password = $c['password'];
                            $username = $c['username'];
                            $isVoucher = false;
                            $isCHAP = true;
                        } else if (!empty($c['pppoe_password']) && Password::chap_verify($c['pppoe_password'], $CHAPassword, $CHAPchallenge)) {
                            $password = $c['pppoe_password'];
                            $username = $c['username'];
                            $isVoucher = false;
                            $isCHAP = true;
                        } else {
                            // check if voucher
                            if (Password::chap_verify($username, $CHAPassword, $CHAPchallenge)) {
                                $isVoucher = true;
                                $password = $username;
                            } else {
                                // no password is voucher
                                if (Password::chap_verify('', $CHAPassword, $CHAPchallenge)) {
                                    $isVoucher = true;
                                    $password = $username;
                                } else {
                                    show_radius_result(['Reply-Message' => 'Username or Password is wrong'], 401);
                                }
                            }
                        }
                    }
                }
            } else {
                if (!empty($username) && empty($password)) {
                    // Voucher with empty password
                    $isVoucher = true;
                    $password = $username;
                } else if (empty($username) || empty($password)) {
                    show_radius_result([
                        "control:Auth-Type" => "Reject",
                        "reply:Reply-Message" => 'Login invalid......'
                    ], 401);
                }
            }
            $tur = ORM::for_table('tbl_user_recharges')->whereRaw("BINARY username = '$username' AND status = 'on'")->find_one();
            file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHORIZE: username=$username, tur_found=" . ($tur ? "YES (routers=" . $tur['routers'] . ")" : "NO") . "\n", FILE_APPEND);
            if (!$tur) {
                // if check if pppoe_username
                $c = ORM::for_table('tbl_customers')->select('username')->select('pppoe_password')->whereRaw("BINARY pppoe_username = '$username'")->find_one();
                if ($c) {
                    $username = $c['username'];
                    $tur = ORM::for_table('tbl_user_recharges')->whereRaw("BINARY username = '$username' AND status = 'on'")->find_one();
                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHORIZE: after pppoe_username check, username=$username, tur_found=" . ($tur ? "YES" : "NO") . "\n", FILE_APPEND);
                }
            }
            if ($tur) {
                if (!$isVoucher && !$isCHAP) {
                    $d = ORM::for_table('tbl_customers')->select('password')->select('pppoe_password')->whereRaw("BINARY username = '$username' AND status = 'Active'")->find_one();
                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHORIZE: password check, customer_found=" . ($d ? "YES" : "NO") . ", password_match=" . ($d && ($d['password'] == $password || $d['pppoe_password'] == $password) ? "YES" : "NO") . "\n", FILE_APPEND);
                    if ($d) {
                        if ($d['password'] != $password) {
                            if ($d['pppoe_password'] != $password) {
                                file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHORIZE: REJECTED - Password wrong for $username\n", FILE_APPEND);
                                show_radius_result(['Reply-Message' => 'Username or Password is wrong'], 401);
                            }
                        }
                    } else {
                        $d = ORM::for_table('tbl_customers')->select('password')->select('pppoe_password')->whereRaw("BINARY pppoe_username = '$username' AND status = 'Active'")->find_one();
                        if ($d) {
                            if ($d['password'] != $password) {
                                if ($d['pppoe_password'] != $password) {
                                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHORIZE: REJECTED - Password wrong for $username (pppoe)\n", FILE_APPEND);
                                    show_radius_result(['Reply-Message' => 'Username or Password is wrong'], 401);
                                }
                            }
                        }
                    }
                }
                // Pour les utilisateurs/vouchers déjà activés, on retourne les attributs
                // SANS control:Auth-Type pour laisser SQL définir Auth-Type automatiquement
                // quand il trouve Cleartext-Password dans radcheck
                file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHORIZE: ACCEPTED - User already activated, returning attributes (no control:Auth-Type, SQL will set it)\n", FILE_APPEND);
                process_radiust_rest($tur, $code, false); // false = ne pas ajouter control:Auth-Type
            } else {
                if ($isVoucher) {
                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER CHECK: username=$username, isVoucher=YES\n", FILE_APPEND);
                    $username = Text::alphanumeric($username, "-_.,");
                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER CHECK: username_clean=$username\n", FILE_APPEND);
                    $v = ORM::for_table('tbl_voucher')->whereRaw("BINARY code = '$username' AND routers = 'radius'")->find_one();
                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER CHECK: voucher_found=" . ($v ? "YES (status=" . $v['status'] . ", routers=" . $v['routers'] . ")" : "NO") . "\n", FILE_APPEND);
                    if ($v) {
                        if ($v['status'] == 0) {
                            file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER ACTIVATION: Attempting to activate voucher, calling Package::rechargeUser(0, " . $v['routers'] . ", " . $v['id_plan'] . ", 'Voucher', '$username')\n", FILE_APPEND);
                            $activation_result = Package::rechargeUser(0, $v['routers'], $v['id_plan'], "Voucher", $username);
                            file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER ACTIVATION: Package::rechargeUser returned=" . ($activation_result ? $activation_result : "FALSE/NULL") . "\n", FILE_APPEND);
                            if ($activation_result) {
                                file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER ACTIVATION: Success, updating voucher status to 1\n", FILE_APPEND);
                                $v->status = "1";
                                $v->used_date = date('Y-m-d H:i:s');
                                $v->save();
                                $tur = ORM::for_table('tbl_user_recharges')->whereRaw("BINARY username = '$username'")->find_one();
                                file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER ACTIVATION: Checking tbl_user_recharges, found=" . ($tur ? "YES (status=" . $tur['status'] . ")" : "NO") . "\n", FILE_APPEND);
                                if ($tur) {
                                    // Voucher activé avec succès, utilisateur créé dans radcheck
                                    // On retourne les attributs directement depuis rlm_rest,
                                    // comme on le fait pour les utilisateurs normaux (ligne 279)
                                    // Cela garantit que FreeRADIUS reçoit les attributs nécessaires
                                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER ACTIVATION: Success! Calling process_radiust_rest to return attributes\n", FILE_APPEND);
                                    process_radiust_rest($tur, $code);
                                } else {
                                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER ACTIVATION: ERROR - tbl_user_recharges entry not found after activation\n", FILE_APPEND);
                                    show_radius_result(['Reply-Message' => 'Voucher activation failed'], 401);
                                }
                            } else {
                                file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER ACTIVATION: ERROR - Package::rechargeUser returned FALSE/NULL\n", FILE_APPEND);
                                show_radius_result(['Reply-Message' => 'Voucher activation failed.'], 401);
                            }
                        } else {
                            file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER CHECK: Status=" . $v['status'] . " (not 0), voucher already used\n", FILE_APPEND);
                            show_radius_result(['Reply-Message' => 'Voucher Expired...'], 401);
                        }
                    } else {
                        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - VOUCHER CHECK: Voucher not found in database\n", FILE_APPEND);
                        show_radius_result(['Reply-Message' => 'Invalid Voucher..'], 401);
                    }
                } else {
                    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - AUTHORIZE: REJECTED - No tbl_user_recharges found for $username (not voucher)\n", FILE_APPEND);
                    show_radius_result(['Reply-Message' => 'Internet Plan Expired..'], 401);
                }
            }
            break;
        case 'accounting':
            $username = _req('User-Name') ?: _req('username');
            if (empty($username)) {
                show_radius_result([
                    "control:Auth-Type" => "Reject",
                    "reply:Reply-Message" => 'Username empty'
                ], 200);
                die();
            }
            header("HTTP/1.1 200 ok");
            // rlm_rest envoie les champs avec les noms RADIUS standards (avec tirets)
            $macAddr = _post('Calling-Station-Id') ?: _post('macAddr') ?: '';
            $nasid = _post('NAS-IP-Address') ?: _post('nasid') ?: '';
            // Chercher la session active (acctstatustype = 'Start') ou la dernière session
            // Utiliser acctsessionid pour trouver la bonne session
            $acctSessionId = _post('Acct-Session-Id') ?: _post('acctSessionId') ?: '';
            $d = null;
            
            // D'abord chercher par session ID (plus précis)
            if (!empty($acctSessionId)) {
                $d = ORM::for_table('rad_acct')
                    ->whereRaw("BINARY username = '$username' AND acctsessionid = '" . $acctSessionId . "'")
                    ->findOne();
            }
            
            // Si pas trouvé, chercher la session active (Start) pour ce username/mac/nas
            if (!$d) {
                $d = ORM::for_table('rad_acct')
                    ->whereRaw("BINARY username = '$username' AND macaddr = '" . $macAddr . "' AND nasid = '" . $nasid . "' AND acctstatustype = 'Start'")
                    ->order_by_desc('dateAdded')
                    ->findOne();
            }
            
            // Si toujours pas trouvé, chercher la dernière session (peut être Stop)
            if (!$d) {
                $d = ORM::for_table('rad_acct')
                    ->whereRaw("BINARY username = '$username' AND macaddr = '" . $macAddr . "' AND nasid = '" . $nasid . "'")
                    ->order_by_desc('dateAdded')
                    ->findOne();
            }
            
            if (!$d) {
                $d = ORM::for_table('rad_acct')->create();
            }
            // Logging pour debug
            file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - ACCOUNTING: username=$username\n", FILE_APPEND);
            file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - POST data: " . print_r($_POST, true) . "\n", FILE_APPEND);
            file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - REQUEST data: " . print_r($_REQUEST, true) . "\n", FILE_APPEND);
            
            // Essayer plusieurs formats de noms de champs (rlm_rest peut envoyer différents formats)
            // rlm_rest peut envoyer en JSON ou en POST standard avec différents formats de noms
            $acctOutputOctets = 0;
            $acctInputOctets = 0;
            $acctSessionTime = 0;
            $acctStatusType = '';
            
            // Essayer tous les formats possibles pour Output Octets
            $possibleOutputNames = ['Acct-Output-Octets', 'acctOutputOctets', 'AcctOutputOctets', 'output-octets', 'outputOctets', 'Acct-Output-Octets', 'AcctOutputOctets'];
            foreach ($possibleOutputNames as $name) {
                $val = _post($name) ?: _req($name);
                if ($val !== false && $val !== '' && $val !== null && $val !== '0') {
                    $acctOutputOctets = intval($val);
                    file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Found OutputOctets in field '$name': $acctOutputOctets\n", FILE_APPEND);
                    break;
                }
            }
            
            // Essayer tous les formats possibles pour Input Octets
            $possibleInputNames = ['Acct-Input-Octets', 'acctInputOctets', 'AcctInputOctets', 'input-octets', 'inputOctets', 'Acct-Input-Octets', 'AcctInputOctets'];
            foreach ($possibleInputNames as $name) {
                $val = _post($name) ?: _req($name);
                if ($val !== false && $val !== '' && $val !== null && $val !== '0') {
                    $acctInputOctets = intval($val);
                    file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Found InputOctets in field '$name': $acctInputOctets\n", FILE_APPEND);
                    break;
                }
            }
            
            // Essayer tous les formats possibles pour Session Time
            $possibleTimeNames = ['Acct-Session-Time', 'acctSessionTime', 'AcctSessionTime', 'session-time', 'sessionTime'];
            foreach ($possibleTimeNames as $name) {
                $val = _post($name) ?: _req($name);
                if ($val !== false && $val !== '' && $val !== null) {
                    $acctSessionTime = intval($val);
                    break;
                }
            }
            
            // Essayer tous les formats possibles pour Status Type
            $possibleStatusNames = ['Acct-Status-Type', 'acctStatusType', 'AcctStatusType', 'status-type', 'statusType'];
            foreach ($possibleStatusNames as $name) {
                $val = _post($name) ?: _req($name);
                if ($val !== false && $val !== '' && $val !== null) {
                    $acctStatusType = $val;
                    break;
                }
            }
            
            // Convertir en int
            $acctOutputOctets = intval($acctOutputOctets);
            $acctInputOctets = intval($acctInputOctets);
            $acctSessionTime = intval($acctSessionTime);
            
            file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Parsed: OutputOctets=$acctOutputOctets, InputOctets=$acctInputOctets, SessionTime=$acctSessionTime, StatusType=$acctStatusType\n", FILE_APPEND);
            
            // Gérer les octets - TOUJOURS mettre à jour si les valeurs sont > 0 ou si c'est un Interim-Update
            // Pour Interim-Update/Alive, les valeurs sont cumulatives depuis le début de la session
            // Pour Start, on initialise, pour Stop, on additionne
            if ($acctStatusType == 'Interim-Update' || $acctStatusType == 'Alive') {
                // Interim-update: les valeurs sont déjà cumulatives, on les remplace
                if ($acctOutputOctets > 0 || $acctInputOctets > 0) {
                    $d->acctOutputOctets = $acctOutputOctets;
                    $d->acctInputOctets = $acctInputOctets;
                    file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Updated octets from Interim-Update: Output=$acctOutputOctets, Input=$acctInputOctets\n", FILE_APPEND);
                }
            } else if ($acctStatusType == 'Start') {
                // Start: initialiser avec les valeurs reçues
                $d->acctOutputOctets = $acctOutputOctets;
                $d->acctInputOctets = $acctInputOctets;
                file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Initialized octets from Start: Output=$acctOutputOctets, Input=$acctInputOctets\n", FILE_APPEND);
            } else if ($acctStatusType == 'Stop') {
                // Stop: additionner (ou remplacer si c'est la valeur finale)
                if (!isset($d->acctOutputOctets) || $d->acctOutputOctets === null) $d->acctOutputOctets = 0;
                if (!isset($d->acctInputOctets) || $d->acctInputOctets === null) $d->acctInputOctets = 0;
                // Pour Stop, les valeurs sont généralement cumulatives, donc on les remplace
                if ($acctOutputOctets > 0 || $acctInputOctets > 0) {
                    $d->acctOutputOctets = $acctOutputOctets;
                    $d->acctInputOctets = $acctInputOctets;
                }
                file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Updated octets from Stop: Output=$acctOutputOctets, Input=$acctInputOctets\n", FILE_APPEND);
            } else {
                // Autres cas: mettre à jour si les valeurs sont > 0
                if ($acctOutputOctets > 0 || $acctInputOctets > 0) {
                    if (!isset($d->acctOutputOctets) || $d->acctOutputOctets === null) $d->acctOutputOctets = 0;
                    if (!isset($d->acctInputOctets) || $d->acctInputOctets === null) $d->acctInputOctets = 0;
                    // Si les nouvelles valeurs sont supérieures, les utiliser (probablement cumulatives)
                    if ($acctOutputOctets >= $d->acctOutputOctets) {
                        $d->acctOutputOctets = $acctOutputOctets;
                    }
                    if ($acctInputOctets >= $d->acctInputOctets) {
                        $d->acctInputOctets = $acctInputOctets;
                    }
                    file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Updated octets (other): Output=$acctOutputOctets, Input=$acctInputOctets\n", FILE_APPEND);
                }
            }
            
            // Initialiser à 0 si pas encore défini
            if (!isset($d->acctOutputOctets) || $d->acctOutputOctets === null) $d->acctOutputOctets = 0;
            if (!isset($d->acctInputOctets) || $d->acctInputOctets === null) $d->acctInputOctets = 0;
            
            $d->acctsessionid = _post('Acct-Session-Id') ?: _post('acctSessionId');
            $d->username = $username;
            $d->realm = _post('realm');
            $d->nasipaddress = _post('NAS-IP-Address') ?: _post('nasIpAddress');
            
            // Gérer le temps de session
            // Acct-Session-Time est le temps total depuis le début de la session (en secondes)
            if ($acctSessionTime !== false && $acctSessionTime !== '' && intval($acctSessionTime) > 0) {
                $d->acctsessiontime = intval($acctSessionTime);
            } else if (isset($d->dateAdded) && !empty($d->dateAdded)) {
                // Calculer depuis dateAdded si Acct-Session-Time n'est pas fourni
                $startTime = strtotime($d->dateAdded);
                $currentTime = time();
                $d->acctsessiontime = max(0, $currentTime - $startTime);
            } else {
                // Par défaut, 0
                if (!isset($d->acctsessiontime) || $d->acctsessiontime === null) $d->acctsessiontime = 0;
            }
            
            file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Final values: SessionTime=" . $d->acctsessiontime . ", OutputOctets=" . $d->acctOutputOctets . ", InputOctets=" . $d->acctInputOctets . "\n", FILE_APPEND);
            $d->nasid = $nasid;
            $d->nasportid = _post('NAS-Port-Id') ?: _post('nasPortId');
            $d->nasporttype = _post('NAS-Port-Type') ?: _post('nasPortType');
            $d->framedipaddress = _post('Framed-IP-Address') ?: _post('framedIPAddress');
            // acctStatusType déjà défini plus haut dans le code (ligne 357)
            if (in_array($acctStatusType, ['Start', 'Stop', 'Interim-Update', 'Alive'])) {
                $d->acctstatustype = $acctStatusType;
            }
            $d->macaddr = $macAddr;
            // Ne mettre à jour dateAdded que lors de la création, pas à chaque update
            if (!$d->id || empty($d->dateAdded)) {
                $d->dateAdded = date('Y-m-d H:i:s');
            }
            
            // Toujours mettre à jour le temps de session même si Acct-Session-Time n'est pas fourni
            // Calculer depuis dateAdded si nécessaire
            if (($d->acctsessiontime == 0 || $d->acctsessiontime === null) && isset($d->dateAdded) && !empty($d->dateAdded)) {
                $startTime = strtotime($d->dateAdded);
                $currentTime = time();
                $calculatedTime = max(0, $currentTime - $startTime);
                if ($calculatedTime > 0) {
                    $d->acctsessiontime = $calculatedTime;
                    file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Calculated session time from dateAdded: $calculatedTime seconds\n", FILE_APPEND);
                }
            }
            
            // pastikan data akunting yang disimpan memang customer aktif phpnuxbill
            $tur = ORM::for_table('tbl_user_recharges')->whereRaw("BINARY username = '$username' AND `status` = 'on' AND `routers` = 'radius'")->find_one();
            if (!$tur) {
                // check if pppoe_username
                $c = ORM::for_table('tbl_customers')->select('username')->whereRaw("BINARY pppoe_username = '$username'")->find_one();
                if ($c) {
                    $username = $c['username'];
                    $tur = ORM::for_table('tbl_user_recharges')->whereRaw("BINARY username = '$username'")->find_one();
                }
            }
            
            // TOUJOURS sauvegarder les données d'accounting, même sans tbl_user_recharges
            // Cela permet de voir toutes les sessions actives dans radon_users
            $d->save();
            file_put_contents("/tmp/radius_debug_accounting.log", date("Y-m-d H:i:s") . " - Data saved: SessionTime=" . $d->acctsessiontime . ", OutputOctets=" . $d->acctOutputOctets . ", InputOctets=" . $d->acctInputOctets . ", StatusType=$acctStatusType\n", FILE_APPEND);
            
            if ($tur) {
                $acctStatusType = _post('Acct-Status-Type') ?: _post('acctStatusType');
                if ($acctStatusType == 'Start') {
                    $plan = ORM::for_table('tbl_plans')->where('id', $tur['plan_id'])->find_one();
                    if ($plan['limit_type'] == "Data_Limit" || $plan['limit_type'] == "Both_Limit") {
                        $totalUsage = $d['acctOutputOctets'] + $d['acctInputOctets'];
                        $attrs['reply:Mikrotik-Total-Limit'] = Text::convertDataUnit($plan['data_limit'], $plan['data_unit']) - $totalUsage;
                        if ($attrs['reply:Mikrotik-Total-Limit'] < 0) {
                            $attrs['reply:Mikrotik-Total-Limit'] = 0;
                            show_radius_result(["control:Auth-Type" => "Accept", 'Reply-Message' => 'You have exceeded your data limit.'], 401);
                        }
                    }
                }
                process_radiust_rest($tur, 200);
            } else {
                // Même sans tbl_user_recharges, retourner une réponse valide
                show_radius_result([
                    "control:Auth-Type" => "Accept",
                    "reply:Reply-Message" => 'Saved'
                ], 200);
            }
            break;
    }
    die();
} catch (Throwable $e) {
    Message::sendTelegram(
        "Sistem Error.\n" .
            $e->getMessage() . "\n" .
            $e->getTraceAsString()
    );
    show_radius_result(['Reply-Message' => 'Command Failed : ' . $action], 401);
} catch (Exception $e) {
    Message::sendTelegram(
        "Sistem Error.\n" .
            $e->getMessage() . "\n" .
            $e->getTraceAsString()
    );
    show_radius_result(['Reply-Message' => 'Command Failed : ' . $action], 401);
}
show_radius_result(['Reply-Message' => 'Invalid Command : ' . $action], 401);

function process_radiust_rest($tur, $code, $add_auth_type = true)
{
    global $config;
    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: START for username=" . $tur['username'] . ", code=$code, add_auth_type=" . ($add_auth_type ? "YES" : "NO") . "\n", FILE_APPEND);
    $plan = ORM::for_table('tbl_plans')->where('id', $tur['plan_id'])->find_one();
    if (!$plan) {
        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: ERROR - Plan not found (id=" . $tur['plan_id'] . ")\n", FILE_APPEND);
        show_radius_result(['Reply-Message' => 'Plan not found'], 401);
        return;
    }
    $bw = ORM::for_table("tbl_bandwidth")->find_one($plan['id_bw']);
    if (!$bw) {
        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: ERROR - Bandwidth not found (id_bw=" . $plan['id_bw'] . ")\n", FILE_APPEND);
        show_radius_result(['Reply-Message' => 'Bandwidth configuration error'], 401);
        return;
    }
    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: Plan and bandwidth found\n", FILE_APPEND);
    // Note: Simultaneous-Use attribute is sent to Mikrotik which handles session limiting
    // We don't need to block here as Mikrotik will enforce the Simultaneous-Use limit
    if ($bw['rate_down_unit'] == 'Kbps') {
        $unitdown = 'K';
    } else {
        $unitdown = 'M';
    }
    if ($bw['rate_up_unit'] == 'Kbps') {
        $unitup = 'K';
    } else {
        $unitup = 'M';
    }
    $rate = $bw['rate_up'] . $unitup . "/" . $bw['rate_down'] . $unitdown;
    $rates = explode('/', $rate);

    if (!empty(trim($bw['burst']))) {
        $ratos = $rate . ' ' . $bw['burst'];
    } else {
        $ratos = $rates[0] . '/' . $rates[1];
    }

    $attrs = [];
    try {
        $timeexp = strtotime($tur['expiration'] . ' ' . $tur['time']);
        if ($timeexp === false) {
            file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: ERROR - Invalid expiration date: " . $tur['expiration'] . " " . $tur['time'] . "\n", FILE_APPEND);
            show_radius_result(['Reply-Message' => 'Invalid expiration date'], 401);
            return;
        }
    } catch (Exception $e) {
        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: ERROR - Exception calculating expiration: " . $e->getMessage() . "\n", FILE_APPEND);
        show_radius_result(['Reply-Message' => 'Date calculation error'], 401);
        return;
    }
    // Removed Reply-Message: success as it causes "login failed: success" error in MikroTik
    // Simultaneous-Use and Port-Limit attributes for Mikrotik session limiting
    // Port-Limit is the standard RADIUS attribute (RFC 2869) for limiting concurrent sessions
    if ($plan['shared_users'] > 0) {
        $attrs['reply:Port-Limit'] = (int)$plan['shared_users'];
        $attrs['Simultaneous-Use'] = (int)$plan['shared_users'];
    }
    $attrs['reply:Mikrotik-Wireless-Comment'] = $plan['name_plan'] . ' | ' . $tur['expiration'] . ' ' . $tur['time'];

    $attrs['reply:Ascend-Data-Rate'] = str_replace('M', '000000', str_replace('K', '000', $rates[1]));
    $attrs['reply:Ascend-Xmit-Rate'] = str_replace('M', '000000', str_replace('K', '000', $rates[0]));
    $attrs['reply:Mikrotik-Rate-Limit'] = $ratos;
    $attrs['reply:WISPr-Bandwidth-Max-Up'] = str_replace('M', '000000', str_replace('K', '000', $rates[0]));
    $attrs['reply:WISPr-Bandwidth-Max-Down'] = str_replace('M', '000000', str_replace('K', '000', $rates[1]));
    $attrs['reply:expiration'] = date('d M Y H:i:s', $timeexp);
    $attrs['reply:WISPr-Session-Terminate-Time'] = date('Y-m-d', $timeexp) . 'T' . date('H:i:sP', $timeexp);
    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: Basic attributes added, count=" . count($attrs) . "\n", FILE_APPEND);

    if ($plan['type'] == 'PPPOE') {
        $attrs['reply:Framed-Pool'] = $plan['pool'];
    }

    if ($plan['typebp'] == "Limited") {
        if ($plan['limit_type'] == "Data_Limit" || $plan['limit_type'] == "Both_Limit") {
            $raddact = ORM::for_table('rad_acct')->whereRaw("BINARY username = '$tur[username]'")->where('acctstatustype', 'Start')->find_one();
            $totalUsage = intval($raddact['acctOutputOctets']) + intval($raddact['acctInputOctets']);
            $attrs['reply:Mikrotik-Total-Limit'] = Text::convertDataUnit($plan['data_limit'], $plan['data_unit']) - $totalUsage;
            if ($attrs['reply:Mikrotik-Total-Limit'] < 0) {
                $attrs['reply:Mikrotik-Total-Limit'] = 0;
                show_radius_result(["control:Auth-Type" => "Accept", 'Reply-Message' => 'You have exceeded your data limit.'], 401);
            }
        }
        if ($plan['limit_type'] == "Time_Limit") {
            if ($plan['time_unit'] == 'Hrs')
                $timelimit = $plan['time_limit'] * 60 * 60;
            else
                $timelimit = $plan['time_limit'] * 60;
            $attrs['reply:Max-All-Session'] = $timelimit;
            $attrs['reply:Expire-After'] = $timelimit;
        } else if ($plan['limit_type'] == "Data_Limit") {
            if ($plan['data_unit'] == 'GB')
                $datalimit = $plan['data_limit'] . "000000000";
            else
                $datalimit = $plan['data_limit'] . "000000";
            $attrs['reply:Max-Data'] = $datalimit;
            $attrs['reply:Mikrotik-Recv-Limit-Gigawords'] = $datalimit;
            $attrs['reply:Mikrotik-Xmit-Limit-Gigawords'] = $datalimit;
        } else if ($plan['limit_type'] == "Both_Limit") {
            if ($plan['time_unit'] == 'Hrs')
                $timelimit = $plan['time_limit'] * 60 * 60;
            else
                $timelimit = $plan['time_limit'] * 60;
            if ($plan['data_unit'] == 'GB')
                $datalimit = $plan['data_limit'] . "000000000";
            else
                $datalimit = $plan['data_limit'] . "000000";
            $attrs['reply:Max-All-Session'] = $timelimit;
            $attrs['reply:Max-Data'] = $datalimit;
            $attrs['reply:Mikrotik-Recv-Limit-Gigawords'] = $datalimit;
            $attrs['reply:Mikrotik-Xmit-Limit-Gigawords'] = $datalimit;
        }
    }
    // Dans authorize, on retourne les attributs reply
    // Si $add_auth_type est true, on ajoute control:Auth-Type: PAP pour les nouveaux vouchers
    // Si $add_auth_type est false, on laisse SQL définir Auth-Type automatiquement
    if ($add_auth_type) {
        $attrs_with_auth_type = array_merge([
            "control:Auth-Type" => "PAP"
        ], $attrs);
        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: Returning " . count($attrs) . " reply attributes + control:Auth-Type: PAP\n", FILE_APPEND);
        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: Attributes: " . implode(', ', array_keys($attrs_with_auth_type)) . "\n", FILE_APPEND);
        show_radius_result($attrs_with_auth_type, $code);
    } else {
        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: Returning " . count($attrs) . " reply attributes (no control:Auth-Type, SQL will set it)\n", FILE_APPEND);
        file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - process_radiust_rest: Attributes: " . implode(', ', array_keys($attrs)) . "\n", FILE_APPEND);
        show_radius_result($attrs, $code);
    }
}

function show_radius_result($array, $code = 200)
{
    if ($code == 401) {
        header("HTTP/1.1 401 Unauthorized");
    } else if ($code == 200) {
        header("HTTP/1.1 200 OK");
    } else if ($code == 204) {
        header("HTTP/1.1 204 No Content");
        die();
    }
    
    // Convertir le format plat en format imbriqué attendu par rlm_rest
    // Format attendu: {"key": {"type": "string", "value": ["value"]}}
    $result = [];
    foreach ($array as $key => $value) {
        if (is_array($value) && isset($value["value"])) {
            // Déjà au bon format, mais s'assurer qu'il a "type"
            if (!isset($value["type"])) {
                // Déterminer le type automatiquement
                $value_type = "string";
                if (is_numeric($value["value"][0] ?? null)) {
                    $value_type = "integer";
                } elseif (is_bool($value["value"][0] ?? null)) {
                    $value_type = "boolean";
                }
                $result[$key] = array_merge(["type" => $value_type], $value);
            } else {
                $result[$key] = $value;
            }
        } else {
            // Convertir au format attendu par rlm_rest avec "type"
            $normalized_value = is_array($value) ? $value : [$value];
            $value_type = "string";
            if (is_numeric($normalized_value[0] ?? null)) {
                $value_type = is_float($normalized_value[0] ?? null) ? "float" : "integer";
            } elseif (is_bool($normalized_value[0] ?? null)) {
                $value_type = "boolean";
            }
            $result[$key] = [
                "type" => $value_type,
                "value" => $normalized_value
            ];
        }
    }
    
    // Si le résultat est vide, retourner un objet vide {} au lieu d'un tableau vide []
    if (empty($result)) {
        $json_response = '{}';
    } else {
        $json_response = json_encode($result);
    }
    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - show_radius_result: Returning JSON response (code=$code) with " . count($result) . " attributes\n", FILE_APPEND);
    file_put_contents("/tmp/radius_debug_authorize.log", date("Y-m-d H:i:s") . " - show_radius_result: JSON preview (first 500 chars): " . substr($json_response, 0, 500) . "\n", FILE_APPEND);
    die($json_response);
}